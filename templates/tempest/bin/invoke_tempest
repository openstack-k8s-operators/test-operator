#!/bin/sh
# NOTE: consider converting it py
set -x
TEMPEST_DIR=$HOME/openshift
OPERATOR_ETC=/etc/test_operator
# NOTE: might be backed with a PV
OUTPUT_PATH=${TEMPEST_OUTPUTDIR:-$HOME/output}

cd "$HOME"

export OS_CLOUD=default

tempest init openshift
mkdir -p "$OUTPUT_PATH"

cd "$TEMPEST_DIR"

# TODO: consider profile support, deployer-input and other args passing
discover-tempest-config --os-cloud "$OS_CLOUD" --debug --create identity.v3_endpoint_type public

if [ -e $OPERATOR_ETC/worker_file.yaml ]; then
    WORKER_FILE="--worker-file $OPERATOR_ETC/worker_file.yaml"
fi

tempest run \
    --concurrency "${TEMPEST_CONCURRENCY}" $WORKER_FILE \
    --include-list "${OPERATOR_ETC}/include.txt" \
    --exclude-list "${OPERATOR_ETC}/exclude.txt"

# NOTE: We might not want to fail when tests are executed
RETURN_VALUE=$?

# NOTE: we have only one run
echo "Generate subunit"
stestr last --subunit > ${OUTPUT_PATH}/testrepository.subunit || true

# NOTE: can be done in parallel
echo "Generate subunit xml file"
subunit2junitxml "${OUTPUT_PATH}/testrepository.subunit" > "${OUTPUT_PATH}/tempest_results.xml" || true

echo "Generate html result"
subunit2html "${OUTPUT_PATH}/testrepository.subunit" "${OUTPUT_PATH}/stestr_results.html" || true

# NOTE: do we really need more files ?
echo Copying logs file
cp -rf ${TEMPEST_DIR}/* ${OUTPUT_PATH}

exit ${RETURN_VALUE}
